# Invoice Generation API - Migration Guide

## Overview

The invoice generation endpoint has been updated to accept the complete unbilled-sessions output format. This simplifies the workflow and provides full client context to invoice templates.

## Key Changes

### 1. Request Body Structure

**Before:**
```json
{
  "client_id": 1,
  "client_name": "John Doe",
  "cost_provider_id": 1,
  "cost_provider_name": "Insurance Co",
  "line_items": [...],
  "auto_generate_pdf": true
}
```

**After (matches unbilled-sessions output):**
```json
{
  "id": 1,
  "first_name": "John",
  "last_name": "Doe",
  "cost_provider_id": 1,
  "sessions": [...],
  "generate_pdf": true,
  "session_from_date": "2024-01-01",
  "session_to_date": "2024-01-31"
}
```

### 2. Field Changes

| Old Field | New Field | Notes |
|-----------|-----------|-------|
| `client_id` | `id` | Client ID |
| `client_name` | `first_name`, `last_name` | Separated fields |
| `cost_provider_name` | `cost_provider.name` | Embedded object |
| `line_items` | `sessions` | SessionResponse array |
| `auto_generate_pdf` | `generate_pdf` | Renamed, **default true** |
| - | `session_from_date` | NEW: Filter sessions |
| - | `session_to_date` | NEW: Filter sessions |

### 3. Default Behavior Change

- **Old:** `auto_generate_pdf` defaulted to `false`
- **New:** `generate_pdf` defaults to `true`

This means PDFs are generated by default unless explicitly disabled.

## Migration Steps

### Step 1: Update Client Code

**Old approach:**
```javascript
// Manually construct request
const request = {
  client_id: client.id,
  client_name: `${client.first_name} ${client.last_name}`,
  cost_provider_id: client.cost_provider_id,
  cost_provider_name: client.cost_provider.name,
  line_items: sessions.map(s => ({
    session_id: s.id,
    description: s.type,
    ...
  })),
  auto_generate_pdf: true
};
```

**New approach:**
```javascript
// Use unbilled-sessions output directly
const unbilledClients = await fetch('/api/v1/client-invoices/unbilled-sessions');
const client = unbilledClients.data[0];

// Add invoice control fields
const request = {
  ...client, // Spread entire client object
  invoice_date: '2024-01-31',
  tax_rate: 19.0,
  generate_pdf: true,
  session_from_date: '2024-01-01',
  session_to_date: '2024-01-31'
};
```

### Step 2: Update Templates

Templates now have access to all client fields:

**Available in template context:**
```json
{
  "invoice": {
    "invoice_number": "...",
    "invoice_date": "...",
    "net_total": 200.00,
    "tax_amount": 38.00,
    "gross_total": 238.00
  },
  "client": {
    "id": 1,
    "first_name": "John",
    "last_name": "Doe",
    "street_address": "123 Main St",
    "zip": "12345",
    "city": "New York",
    "email": "john@example.com",
    "therapy_title": "CBT",
    "provider_approval_code": "PROV123",
    ... // All other client fields
  },
  "cost_provider": {
    "id": 1,
    "name": "Insurance Co",
    ...
  },
  "sessions": [
    {
      "id": 1,
      "original_date": "2024-01-15T00:00:00Z",
      "duration_min": 60,
      "type": "therapy",
      "number_units": 1
    },
    ...
  ]
}
```

## New Features

### 1. Session Date Filtering

Filter which sessions to include in the invoice:

```json
{
  ...client_data,
  "session_from_date": "2024-01-01",
  "session_to_date": "2024-01-31"
}
```

Only sessions with `original_date` within this range will be included.

### 2. Complete Client Context

All client fields are now available in templates:
- Contact information
- Alternative contacts
- Therapy details
- Provider approval info
- Custom fields

### 3. Simplified Workflow

```
1. GET /client-invoices/unbilled-sessions
2. Select client from response
3. Add invoice control fields
4. POST /client-invoices/generate
```

## Benefits

✅ **Less code** - No manual request construction  
✅ **Type safety** - Request matches response structure  
✅ **Rich templates** - Access to all client data  
✅ **Flexible filtering** - Date-based session selection  
✅ **Default PDF generation** - PDFs created by default  
✅ **Consistency** - Same structure throughout API  

## Backward Compatibility

⚠️ This is a **breaking change**. The old request format is no longer supported.

**Migration required for:**
- Frontend invoice generation forms
- Invoice templates (update field references)
- API integration tests
- Documentation

## Testing

Run the test script to verify:

```bash
cd /Users/alex/src/ae/backend/unburdy_server
./tests/test-invoice-with-pdf.sh
```

## See Also

- [INVOICE_PDF_GENERATION.md](./INVOICE_PDF_GENERATION.md) - Full API documentation
- [Test Script](../tests/test-invoice-with-pdf.sh) - Integration test examples
